name: Build OnePlus_Kernel
on:
  schedule:
    - cron: '0 3 * * *'  # 每天3点运行 
  workflow_dispatch: {}   # 保留手动触发但不带参数

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 允许创建 Releases 和上传文件
    env:
      CPU: sm8650
      FEIL: oneplus12_v
      CPUD: pineapple
      ANDROID_VERSION: android14
      KERNEL_VERSION: '6.1'
      KERNEL_NAME: -android14-o-hange
      kernelsu_variant: SukiSU
      kernelsu_version: main
      SUSFS_ENABLED: true
      VFS_patch_ENABLED: enable

    steps:
      # ... 此处省略前序未修改的步骤 ...

      - name: Make AnyKernel3
        run: |
          git clone https://github.com/Kernel-SU/AnyKernel3 --depth=1
          rm -rf ./AnyKernel3/.git
          cp kernel_workspace/kernel_platform/out/msm-kernel-${{ env.CPUD }}-gki/dist/Image ./AnyKernel3/

      - name: Make AnyKernel3 ZIP  # 新增压缩步骤
        run: |
          cd AnyKernel3
          zip -r ../AnyKernel3_KernelSU_${{ env.KSUVER }}.zip ./*

      - name: Upload AnyKernel3
        uses: actions/upload-artifact@v4
        with:
          name: AnyKernel3_KernelSU_${{ env.KSUVER }}_${{ env.FEIL }}
          path: ./AnyKernel3_KernelSU_${{ env.KSUVER }}.zip

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "v${{ env.KSUVER }}"
          release_name: "OnePlus12 SukiSU Build ${{ env.KSUVER }}"
          draft: false
          prerelease: false

      - name: Upload AnyKernel3 to Release  # 修改后的上传步骤
        uses: actions/upload-release-asset@v2  # 升级到v2版本
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./AnyKernel3_KernelSU_${{ env.KSUVER }}.zip
          asset_name: AnyKernel3_KernelSU_${{ env.KSUVER }}.zip
          asset_content_type: application/zip  # 指定MIME类型
